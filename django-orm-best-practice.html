<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🗿&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Django ORM：天使与魔鬼&nbsp;|&nbsp;布鲁斯🐟的奇思乱想</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Django ORM：天使与魔鬼">
  
    <meta name="description" content="平时是小天使，出了问题就是大撒旦">
    <meta property="og:description" content="平时是小天使，出了问题就是大撒旦">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;👹&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🗿&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="0316b907039e49eb86c087e28a94f00b.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🧱&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>Projects</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3a9bcf6a-f4f8-4580-93a6-b21a38a8914b%2F988431636594419_.pic.jpg?table=block&amp;id=78f0b500-97be-4b05-ad6d-630418880655"></span>&nbsp;
          
          <span>关于,布鲁斯鱼,a,https://github.com/IMBlues</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://images.unsplash.com/photo-1561411996-3794338f63cc?ixlib=rb-1.2.1&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;ixid=eyJhcHBfaWQiOjYzOTIxfQ">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;👹&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">Django ORM：天使与魔鬼</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Nov 27, 2020</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/web.html">web</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
            <a href="tag/django.html">django</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--brown">
            <a href="tag/orm.html">orm</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
            <a href="tag/best-practice.html">best-practice</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
            <a href="tag/tech.html">tech</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/982e294cabb247aa878134d8bb6fd6ce" class="PageRoot"><div id="https://www.notion.so/65eb3916500142db8115b161d79ad878" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><ul id="https://www.notion.so/ae374395897843c3b06826ed14984083" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/6c1bbcd66e4d4e7782844ab050c1219b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">魔鬼的陷阱</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c436ae0ebfb34819bc4fb3fbe9246a57"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 的类型</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/120a19e13232487f96225b1ae3e82b96"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">有时候希望它简单一点</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f603f2fbd0324a8499a73d36b96392f8"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">有时候希望它坚持自我</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/6db8e2a3ed26424993cb9663b65027db"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">多对多和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/6c9af6e675e448fea225e5a014efe4e5"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">ORM 终究只是 ORM</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/701ba0fe21374e35bd159414d89b92b3"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">隐式转换</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d4c352263bb64a008bc81cba9941d68c"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">Mysql 低版本时间精度问题</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f618f11ceb5f4e6eb7cd69cc151f026b"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">虚假的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.query</code></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1ea4c6d533ef44b08d8364ea11a16bb8"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">天使的眼泪</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/162617b046c941da99734d9bc18c8eca"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">巧用 extra</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/acc07a2e8c4e425bb3a3f3a7f48cf0cc"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JsonField</code></span><span class="SemanticString"> 的福音—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JSON_SEARCH</code></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4d5853a07d6d48a197c3cd1e428933a7"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">行锁的支持</span></span></div></a></li></ul><div id="https://www.notion.so/1df92409ac024080b676fc7d3bdd70f1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><blockquote id="https://www.notion.so/4a306f5ed2fc4f81bb023f2c5beaabfa" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">作为一只以 Django 作为主力开发框架的 CRUD Boy ，时常和它的 ORM 缠绵悱恻、纠缠不清，特此记录一下这些笑与泪的记忆。</span></span></blockquote><h1 id="https://www.notion.so/6c1bbcd66e4d4e7782844ab050c1219b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/6c1bbcd66e4d4e7782844ab050c1219b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">魔鬼的陷阱</span></span></h1><h2 id="https://www.notion.so/c436ae0ebfb34819bc4fb3fbe9246a57" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c436ae0ebfb34819bc4fb3fbe9246a57"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 的类型</span></span></h2><h3 id="https://www.notion.so/120a19e13232487f96225b1ae3e82b96" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/120a19e13232487f96225b1ae3e82b96"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">有时候希望它简单一点</span></span></h3><div id="https://www.notion.so/e8e3441e58f64808a57217549b7d07ef" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">objects.values()</code></span><span class="SemanticString"> 返回的并不是简单类型的数据，而是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString">。一般直接用来做 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Response</code></span><span class="SemanticString"> 没有问题，但是要知道 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 是不能被 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pickle</code></span><span class="SemanticString"> 的，如果使用到 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Django Cache</code></span><span class="SemanticString"> 之类功能，直接用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 当作返回会死得很惨。</span></span></p></div><div id="https://www.notion.so/ff5f940839bc48d89ae016731aa9c6ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/f603f2fbd0324a8499a73d36b96392f8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f603f2fbd0324a8499a73d36b96392f8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">有时候希望它坚持自我</span></span></h3><div id="https://www.notion.so/0e3ffa2a8eab498da16d8858bc82861c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">很多时候我们需要限制 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 返回的字段以加快 DB 查询的速度（比如一些没索引的长字段)，这时候可能的两个方法： </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">only()</code></span><span class="SemanticString"> &amp; </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 。</span></span></p></div><div id="https://www.notion.so/1a76639d83a64d2581c940d2f6b2fcb7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但实际情况是，使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 会改变 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queryset._iterable_class</code></span><span class="SemanticString"> ，如果后面还有更多的级联查询，会导致最后的结果为 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Dict</code></span><span class="SemanticString"> 而不是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/df8188cbb2bc4446b33107f9dbff5f45" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/6db8e2a3ed26424993cb9663b65027db" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6db8e2a3ed26424993cb9663b65027db"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">多对多和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span></span></h2><div id="https://www.notion.so/2312ce96c5414a7abaa06aabeea7b424" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">存在一个模型</span></span></p></div><pre id="https://www.notion.so/516ac619647941459525fa359a8e25ce" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token operator">**</span>some_params<span class="token punctuation">)</span>
    bars <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span><span class="token operator">**</span>some_params<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/a594144a4bfa4a1299f9cd22b8cb05d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">存在一条记录</span></span></p></div><pre id="https://www.notion.so/ce72c123401544e8ba02381db0d0a755" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>foo<span class="token punctuation">:</span>
  name<span class="token punctuation">:</span> tom
  bars<span class="token punctuation">:</span>
    <span class="token operator">-</span> a
    <span class="token operator">-</span> b </span></span></span></code></pre><div id="https://www.notion.so/7f8fd448c9c546f5990cd3cf99b47855" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 预期返回</span></span></p></div><pre id="https://www.notion.so/47d04002f0954b638a2fe2d0c273586c" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span>
        <span class="token property">"bars"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span></span></span></span></code></pre><div id="https://www.notion.so/0d8a49efdc9a4ea8a01d3a66f92ef8ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">实际返回</span></span></p></div><pre id="https://www.notion.so/376ac1aaae6a490ba7f1c4293e6d3c6f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span>
        <span class="token property">"bars"</span><span class="token operator">:</span> <span class="token string">"a"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span>
        <span class="token property">"bars"</span><span class="token operator">:</span> <span class="token string">"b"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span></span></span></span></code></pre><div id="https://www.notion.so/2fa597b3038e4882834930f673a51010" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3190438608db4193921b84728cfdef7c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">没有什么太好的调整办法，只能注意 + 规避，详见: </span></span></p></div><div id="https://www.notion.so/ed9afc00e69747ce940cca0c9bc3ce0d" class="Bookmark"><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#values"><h5 class="Bookmark__Title">QuerySet API reference | Django documentation | Django</h5><p class="Bookmark__Desc">Django provides a range of refinement methods that modify either the types of results returned by the or the way its SQL query is executed. Returns a new containing objects that do not match the given lookup parameters. The lookup parameters () should be in the format described in Field lookups below.</p><p class="Bookmark__Link">https://docs.djangoproject.com/en/1.11/ref/models/querysets/#values</p></a></div><div id="https://www.notion.so/f26dd53e313f495986afa0be00dbaf06" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd55d79b9-fe83-43dd-8194-f02c9fea19d8%2FUntitled.png?width=873&amp;table=block&amp;id=f26dd53e-313f-4959-86af-a0be00dbaf06"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd55d79b9-fe83-43dd-8194-f02c9fea19d8%2FUntitled.png?width=873&amp;table=block&amp;id=f26dd53e-313f-4959-86af-a0be00dbaf06" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/26a0e17bdf144da9beb8c803ff731926" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/6c9af6e675e448fea225e5a014efe4e5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6c9af6e675e448fea225e5a014efe4e5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ORM 终究只是 ORM</span></span></h2><div id="https://www.notion.so/c4515a8083a442259f293ef3c0e3ab38" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/72e813d012b1403f8ec3cf7c158dd7c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们要时刻记住, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">orm</code></span><span class="SemanticString"> 只是做一个映射，有时候拿到的对象和我们预想并不能完全一致。</span></span></p></div><h3 id="https://www.notion.so/701ba0fe21374e35bd159414d89b92b3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/701ba0fe21374e35bd159414d89b92b3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">隐式转换</span></span></h3><pre id="https://www.notion.so/9fd7c1a9f5ce4591a7a8316455423263" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 这里先忽略 timezone 问题</span>
f1 <span class="token operator">=</span> Foo<span class="token punctuation">(</span>created<span class="token operator">=</span><span class="token string">'2020-09-18 09:46:23.544799'</span><span class="token punctuation">)</span>

<span class="token comment"># 字符串会被存储，Django 做了隐式转换</span>
f1<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># str</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>f1<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">)</span>

f2 <span class="token operator">=</span> Foo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>f1<span class="token punctuation">.</span>pk<span class="token punctuation">)</span>

<span class="token comment"># Datetime 对象！</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>f2<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/34abe9dc36824f97bf4b46f29816ac85" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/83a9e6e0d99f4295a673b051a47669dd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过以上的例子就能知道，我们自己创建的内存对象 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f1</code></span><span class="SemanticString"> 和通过 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">orm</code></span><span class="SemanticString"> 拿出来的内存对象 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f2</code></span><span class="SemanticString"> 完全不是同一个东西，虽然他们都可以操作同一条数据库记录，但如果在内存对象里做比较就会有很多问题，比如下面的例子</span></span></p></div><div id="https://www.notion.so/ba5976446ab84f75873643606d6035ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/d4c352263bb64a008bc81cba9941d68c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d4c352263bb64a008bc81cba9941d68c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Mysql 低版本时间精度问题</span></span></h3><pre id="https://www.notion.so/854866553124422aa2c6c9bd317148b8" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 假定 Foo 表中已经存在了比较多的记录</span>
f <span class="token operator">=</span> Foo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 我们预期是获取按照时间来排序，f 的前一条记录</span>
o <span class="token operator">=</span> Foo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>created_lt<span class="token operator">=</span>f<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">.</span>latest<span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">)</span>

<span class="token keyword">assert</span> o<span class="token punctuation">.</span>pk <span class="token operator">==</span> f<span class="token punctuation">.</span>pk
<span class="token comment"># mysql 版本大于 5.6.4 时 -> False</span>
<span class="token comment"># mysql 版本小于 5.6.4 时 -> True</span></span></span></span></code></pre><div id="https://www.notion.so/c8504db620c64ef29ab169a63ea1320b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">原因很简单，当 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">mysql</code></span><span class="SemanticString"> 版本小于 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">5.6.4</code></span><span class="SemanticString"> 时是不支持 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">microseconds</code></span><span class="SemanticString"> 的，由于我们的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f</code></span><span class="SemanticString"> 是内存对象，拿到的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">created</code></span><span class="SemanticString"> 又是有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">microseconds</code></span><span class="SemanticString"> 的，相当于我们在用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">2020-09-18 09:24:38.260779</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">2020-09-18 09:24:38.000000</code></span><span class="SemanticString"> 做比较， </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">o</code></span><span class="SemanticString"> 一直拿到的就是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f</code></span><span class="SemanticString"> 对应的记录...</span></span></p></div><div id="https://www.notion.so/abb4542965884cd48b0704b7543b06c8" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F53b61d4b-0742-48a9-ac2c-54311236400f%2FUntitled.png?width=432&amp;table=block&amp;id=abb45429-6588-4cd4-8b07-04b7543b06c8"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F53b61d4b-0742-48a9-ac2c-54311236400f%2FUntitled.png?width=432&amp;table=block&amp;id=abb45429-6588-4cd4-8b07-04b7543b06c8" style="width:432px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e770841da5654cbeb6d4d6119198f395" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/f618f11ceb5f4e6eb7cd69cc151f026b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f618f11ceb5f4e6eb7cd69cc151f026b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">虚假的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.query</code></span></span></h2><div id="https://www.notion.so/bcfcf9ae99414f86a116a21fbbd7fd0f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a692a669d9554f9997df85f289c8ac84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们常常用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queryset.query</code></span><span class="SemanticString"> 去检查复杂的查询语句，但实际上 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">query</code></span><span class="SemanticString"> 属性并不能真实反应提交到 DB 中的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sql</code></span><span class="SemanticString"> ，可以参考如下链接：</span></span></p></div><div id="https://www.notion.so/dadcf3b3611d47c09032bc3866edee31" class="Bookmark"><a href="https://code.djangoproject.com/ticket/17741"><h5 class="Bookmark__Title">QuerySet.query.__str__() does not generate valid MySQL query with dates</h5><p class="Bookmark__Desc">If you have a date parameter in a QuerySet, the string of the query is not valid SQL in MySQL and will generate a warning.</p><p class="Bookmark__Link">https://code.djangoproject.com/ticket/17741</p></a></div><div id="https://www.notion.so/f8033d2acf7a419ba31e4302c024ef6c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f35f10b18b214aad8383e122260b182d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那么如何调试提交到 DB 中的具体语句呢？</span></span></p></div><pre id="https://www.notion.so/dbb143ee8380465ea58773d6184445db" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> connection

<span class="token comment"># 在语句提交之后，立即打印</span>
<span class="token comment"># 同时需要记得开启 DEBUG = True</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span>queries<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/4039d41f0f2048bd8f362b2bf8074361" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">再或者，直接</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://stackoverflow.com/questions/650238/how-to-show-the-last-queries-executed-on-mysql">在 DB 中开启 general_log</a></span><span class="SemanticString"> 。</span></span></p></div><div id="https://www.notion.so/4c22b1b15bf04ca9ab2d4d5749343835" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/1ea4c6d533ef44b08d8364ea11a16bb8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/1ea4c6d533ef44b08d8364ea11a16bb8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">天使的眼泪</span></span></h1><h2 id="https://www.notion.so/162617b046c941da99734d9bc18c8eca" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/162617b046c941da99734d9bc18c8eca"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">巧用 extra</span></span></h2><div id="https://www.notion.so/f12494a7a8bc4c2588986d5052d0b457" class="Bookmark"><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#extra"><h5 class="Bookmark__Title">QuerySet API reference | Django documentation | Django</h5><p class="Bookmark__Desc">Django provides a range of refinement methods that modify either the types of results returned by the or the way its SQL query is executed. Returns a new containing objects that do not match the given lookup parameters. The lookup parameters () should be in the format described in Field lookups below.</p><p class="Bookmark__Link">https://docs.djangoproject.com/en/1.11/ref/models/querysets/#extra</p></a></div><div id="https://www.notion.so/403186d68af14bd49add2428bb10df36" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7005ffc717ee4130bc43297c3b2aafd5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">extra()</code></span><span class="SemanticString"> 可以利用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sql</code></span><span class="SemanticString"> 在数据库中做数据处理，而不用放到内存中，在数据量较大时有比较好的效果，比如：</span></span></p></div><div id="https://www.notion.so/a3ed25e35d9b4c568e84ed89d614787d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/4e74cfc4290f4cf3880b1ce716f2fd81" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>queryset <span class="token operator">=</span> queryset<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">"CONCAT(username, '@', domain)"</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/f51be0098d884db1a0b80443262781f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/78702bc4168542bf8f1d77913cb25ac1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在模糊查询时，匹配最短结果</span></span></p></div><pre id="https://www.notion.so/f75715e8c09c42b6af6305e5800e1622" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>MyModel<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'myfield_length'</span><span class="token punctuation">:</span><span class="token string">'Length(myfield)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'myfield_length'</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/049161c443194efbbc90c78469ce4674" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ebfff28f8890470eac3b1f29f03ed1c3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但在同时需要格外小心， </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">extra()</code></span><span class="SemanticString"> 在参数上存在注入风险，所有可能的用户输入的 SQL 拼接，都应该交给 Django 处理。</span></span></p></div><pre id="https://www.notion.so/9f2f462dece74c03aa643fe99cac1985" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># 有注入风险, username 不会被转义，可以直接注入</span>
Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>where<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"headline='</span><span class="token interpolation"><span class="token punctuation">{</span>username<span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 安全，Django 会将 username 内容转义</span>
Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>where<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'headline=%s'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span></span></code></pre><h2 id="https://www.notion.so/acc07a2e8c4e425bb3a3f3a7f48cf0cc" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/acc07a2e8c4e425bb3a3f3a7f48cf0cc"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JsonField</code></span><span class="SemanticString"> 的福音—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JSON_SEARCH</code></span></span></h2><div id="https://www.notion.so/dbdb29f2606748aab873230f4e581bb5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有时候我们需要使用动态字段，并且保证动态字段的值全表唯一。动态字段我们使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">LONGTEXT</code></span><span class="SemanticString"> 存储，格式为 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JSON</code></span><span class="SemanticString"> 。如果手动处理，需要将整个表的字段放到内存，并做唯一校验，非常麻烦且耗时。</span></span></p></div><div id="https://www.notion.so/1ab7b6b7335d42d9ad363862e1e044b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">所以还是一个道理，把这个逻辑交给 DB</span></span></p></div><pre id="https://www.notion.so/7c45139179054983b5efc9ceaa50b6f6" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> profiles_profile <span class="token keyword">where</span> JSON_SEARCH<span class="token punctuation">(</span>extras<span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"aaa"</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/c16601909fca4a63ab73cb94f27d905b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/4d5853a07d6d48a197c3cd1e428933a7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/4d5853a07d6d48a197c3cd1e428933a7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">行锁的支持</span></span></h2><div id="https://www.notion.so/bce18671696b47df8fde1c582cccdd32" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">多个操作互斥的情况下，可以使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">select_for_update</code></span><span class="SemanticString"> 行锁保证正确性。</span></span></p></div><pre id="https://www.notion.so/7851b7be70b943b7a13068b159696e33" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">with</span> transaction<span class="token punctuation">.</span>atomic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 仅在 transaction 内生效</span>
    Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_for_update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Hello"</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/145c0edd05d4429a829ef581838006b3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/5b48843a1a934ade8495125e2e246d07" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但是同时需要注意，上锁的顺序，避免产生死锁。</span></span></p></div></article>
  <footer class="Footer">
  <div>&copy; 布鲁斯🐟的奇思乱想 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>