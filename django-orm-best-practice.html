<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WV23EXEF9X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-WV23EXEF9X');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="Django ORM：天使与魔鬼">
    <meta name="description" content="平时是小天使，出了问题就是大撒旦">
  <meta property="og:description" content="平时是小天使，出了问题就是大撒旦">
    <meta property="og:type" content="blog">
  <title>Django ORM：天使与魔鬼</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="🗿">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>🗿</span> <span>Home</span></div>
    </a>
                                            <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>🎃</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
          <div class="Header__Cover">
        <img src="https://images.unsplash.com/photo-1561411996-3794338f63cc?ixlib=rb-1.2.1&q=85&fm=jpg&crop=entropy&cs=srgb&ixid=eyJhcHBfaWQiOjYzOTIxfQ">
      </div>
          <div class="Header__Spacer ">
    </div>
        <div class="Header__Icon"><span>👹</span></div>
        <h1 class="Header__Title">Django ORM：天使与魔鬼</h1>
            <div class="DateTagBar">
                <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Nov 27, 2020</span>
                          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/web.html">web</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
            <a href="tag/django.html">django</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--brown">
            <a href="tag/orm.html">orm</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
            <a href="tag/best-practice.html">best-practice</a>
          </span>
                  </div>
          </header>
      <article id="https://www.notion.so/94a28416ce6b44ac91e15744eea88dd4" class="PageRoot PageRoot--FullWidth"><div id="https://www.notion.so/d5af5c5f6035457082ad1ef23502c58b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><ul id="https://www.notion.so/77815a7a9a684bf88af5b1a0269d6f24" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/5061352e79dd425c87e1399aea569e0b"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 的类型陷阱</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/df75d8d0b3d445e49b4c73812387aa2b"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">有时候希望它是简单类型</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/325da1843c9c4c7dad776b90d99a3d57"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">有时候希望它仍旧是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/7afd58ae9a8244b29df5e6b8954931c7"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">巧用 extra </span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2df130b58b64487c9a39d07a7dd37219"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JsonField</code></span><span class="SemanticString"> 的福音—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JSON_SEARCH</code></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/629ff8f8781441ab88c2660f3b111219"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">行锁</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c0f6214e5dd54747882de80cb11a28a6"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">多对多和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/28af2acc9bde4c8892812c84c83053b0"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">ORM 终究只是 ORM</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f96ee6e9ede54b41aa09a583801590c2"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">隐式转换</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b08dabe0bc2e4dff991b354ed8a89bef"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Mysql 低版本时间精度问题</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3439f10f660f442a81376effd1df43e2"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">虚假的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.query</code></span></span></div></a></li></ul><div id="https://www.notion.so/91c3effb15414d7c8fc42c7ebf3205ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3fd7584acb8349f68f49eae2011e85b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/5061352e79dd425c87e1399aea569e0b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5061352e79dd425c87e1399aea569e0b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 的类型陷阱</span></span></h2><div id="https://www.notion.so/4cd5a45cce1e4da79913a33bd8d63f86" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/df75d8d0b3d445e49b4c73812387aa2b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/df75d8d0b3d445e49b4c73812387aa2b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">有时候希望它是简单类型</span></span></h3><div id="https://www.notion.so/a912bf667c054c3ca428ab2fb9106254" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">而 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">objects.values()</code></span><span class="SemanticString"> 返回的并不是数据，而是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString">。一般用来做 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Response</code></span><span class="SemanticString"> 没有问题，但是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 是不能被 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pickle</code></span><span class="SemanticString"> 的，如果使用到 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Django Cache</code></span><span class="SemanticString"> 之类功能，会直接报错。</span></span></p></div><div id="https://www.notion.so/6b61bc0c702140f9885370958bcbd225" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/325da1843c9c4c7dad776b90d99a3d57" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/325da1843c9c4c7dad776b90d99a3d57"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">有时候希望它仍旧是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span></span></h3><div id="https://www.notion.so/c0ca1caeb6274a959a8ddd5430d9ced6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">很多时候我们需要限制 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span><span class="SemanticString"> 返回的字段以加快 DB 查询的速度（比如一些没索引的长字段)，这时候可能的两个方法： </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">only()</code></span><span class="SemanticString"> &amp; </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 。</span></span></p></div><div id="https://www.notion.so/cf3b0e88064443de9896a46218f0656f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但实际情况是，使用需要注意， </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 会改变 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queryset._iterable_class</code></span><span class="SemanticString"> ，如果后面还有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queryset</code></span><span class="SemanticString"> 的级联查询，会导致最后的结果为 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Dict</code></span><span class="SemanticString"> 而不是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">QuerySet</code></span></span></p></div><div id="https://www.notion.so/8dc0b87c1e5a4e45af3488680bd43795" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/af6e5f51d5ed4a97a92b9ce98010f245" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/75a67352f55148989cf9045b9a6b804b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/606ad655f4ad4f4da7188aab9cfc86bd" class="Divider"></div><h2 id="https://www.notion.so/7afd58ae9a8244b29df5e6b8954931c7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/7afd58ae9a8244b29df5e6b8954931c7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">巧用 extra </span></span></h2><div id="https://www.notion.so/8cb4b9939a7b4ed0a67424076db809e8" class="Bookmark"><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#extra"><h5 class="Bookmark__Title">QuerySet API reference | Django documentation | Django</h5><p class="Bookmark__Desc">Django provides a range of refinement methods that modify either the types of results returned by the or the way its SQL query is executed. Returns a new containing objects that do not match the given lookup parameters. The lookup parameters () should be in the format described in Field lookups below.</p><p class="Bookmark__Link">https://docs.djangoproject.com/en/1.11/ref/models/querysets/#extra</p></a></div><div id="https://www.notion.so/e6523e5eedca449d8f8add3945c94331" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/420fed93f5dd422fa5b8b31c69ddc06b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">extra()</code></span><span class="SemanticString"> 可以利用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sql</code></span><span class="SemanticString"> 在数据库中做数据处理，而不用放到内存中，在数据量较大时有比较好的效果，比如：</span></span></p></div><div id="https://www.notion.so/c87aaae9e64a4dc3a9152cec45112964" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/4dca08f0298141fd8d4aa70947f1cbbf" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>queryset <span class="token operator">=</span> queryset<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">"CONCAT(username, '@', domain)"</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/b4b65f47c26141eeb123d59491c78241" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ad670af14adb4309a53817b1b9180716" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在模糊查询时，匹配最短结果</span></span></p></div><pre id="https://www.notion.so/ad09a005a149471795a5464090a14de0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>MyModel<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'myfield_length'</span><span class="token punctuation">:</span><span class="token string">'Length(myfield)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'myfield_length'</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/5ee8e4a7a5414262b2a45f89a25e91e9" class="Divider"></div><h2 id="https://www.notion.so/2df130b58b64487c9a39d07a7dd37219" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2df130b58b64487c9a39d07a7dd37219"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JsonField</code></span><span class="SemanticString"> 的福音—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JSON_SEARCH</code></span></span></h2><div id="https://www.notion.so/f77a65c8d4594c4ea7bae43954130581" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有时候我们需要使用动态字段，并且保证动态字段的值全表唯一。动态字段我们使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">LONGTEXT</code></span><span class="SemanticString"> 存储，格式为 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">JSON</code></span><span class="SemanticString"> 。如果手动处理，需要将整个表的字段放到内存，并做唯一校验，非常麻烦且耗时。</span></span></p></div><div id="https://www.notion.so/07d0639e87784d8eb0ea41ac07541402" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">所以还是一个道理，把这个逻辑交给 DB</span></span></p></div><pre id="https://www.notion.so/7fe9007cbef74afd8b556bc4ff5c46b6" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> profiles_profile <span class="token keyword">where</span> JSON_SEARCH<span class="token punctuation">(</span>extras<span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"aaa"</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/6f5fa319ca16451f8b0f425ad9f46c7c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9352e20872294077afce192e846c2d4a" class="Divider"></div><h2 id="https://www.notion.so/629ff8f8781441ab88c2660f3b111219" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/629ff8f8781441ab88c2660f3b111219"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">行锁</span></span></h2><div id="https://www.notion.so/84a186a384574bbb93ae8fc1bee2ab05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">多个操作互斥的情况下，可以使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">select_for_update</code></span><span class="SemanticString"> 行锁保证正确性。</span></span></p></div><pre id="https://www.notion.so/4b6ef6a0e8474b399e11316369769971" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">with</span> transaction<span class="token punctuation">.</span>atomic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 仅在 transaction 内生效</span>
    Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_for_update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Hello"</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/4a2ee6ace7844585bff6157546c6fef8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/c0f6214e5dd54747882de80cb11a28a6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c0f6214e5dd54747882de80cb11a28a6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">多对多和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span></span></h2><div id="https://www.notion.so/b5451ab310594767880957eff96ede3c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">存在一个模型</span></span></p></div><pre id="https://www.notion.so/6ffb3c88aaa3446ebd20d1e508f223c0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token operator">**</span>some_params<span class="token punctuation">)</span>
    bars <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span><span class="token operator">**</span>some_params<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/8de782dfa3b54d69b6cffc6ae140ed49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">存在一条记录</span></span></p></div><pre id="https://www.notion.so/d876249ffb98409f9d95324f520ed017" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>foo<span class="token punctuation">:</span>
  name<span class="token punctuation">:</span> tom
  bars<span class="token punctuation">:</span>
    <span class="token operator">-</span> a
    <span class="token operator">-</span> b </span></span></span></code></pre><div id="https://www.notion.so/f3ff6849c8b7470fa18e0c3f52df8ea1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">values()</code></span><span class="SemanticString"> 预期返回</span></span></p></div><pre id="https://www.notion.so/6b21a3c726da4c8dad6e1163c439c86b" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span>
        <span class="token property">"bars"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span></span></span></span></code></pre><div id="https://www.notion.so/3809d28da28645419f78dbba51e0d12b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">实际返回</span></span></p></div><pre id="https://www.notion.so/a71e2fdeb5034f78b5d99865cdac13f0" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span>
        <span class="token property">"bars"</span><span class="token operator">:</span> <span class="token string">"a"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span>
        <span class="token property">"bars"</span><span class="token operator">:</span> <span class="token string">"b"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span></span></span></span></code></pre><div id="https://www.notion.so/27004c30c88346709d3bf829370b7888" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/738a70d589904afcbbbdb30f8ecfa39d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">没有什么太好的调整办法，只能注意 + 规避，详见: </span></span></p></div><div id="https://www.notion.so/cafd2221b032459aa713abd10eca78f1" class="Bookmark"><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#values"><h5 class="Bookmark__Title">QuerySet API reference | Django documentation | Django</h5><p class="Bookmark__Desc">Django provides a range of refinement methods that modify either the types of results returned by the or the way its SQL query is executed. Returns a new containing objects that do not match the given lookup parameters. The lookup parameters () should be in the format described in Field lookups below.</p><p class="Bookmark__Link">https://docs.djangoproject.com/en/1.11/ref/models/querysets/#values</p></a></div><div id="https://www.notion.so/f5e80784e3ed4d8da9c8848c91e81d29" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd55d79b9-fe83-43dd-8194-f02c9fea19d8%2FUntitled.png?width=873&amp;table=block&amp;id=f5e80784-e3ed-4d8d-a9c8-848c91e81d29"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd55d79b9-fe83-43dd-8194-f02c9fea19d8%2FUntitled.png?width=873&amp;table=block&amp;id=f5e80784-e3ed-4d8d-a9c8-848c91e81d29" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d370bbadd8c94550962dac8dab7a9113" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/28af2acc9bde4c8892812c84c83053b0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/28af2acc9bde4c8892812c84c83053b0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ORM 终究只是 ORM</span></span></h2><div id="https://www.notion.so/9a5a3b4e875642d484fab88495b76d1c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/adb7c8a2d128496a98a8854eb14ba61a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们要时刻记住, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">orm</code></span><span class="SemanticString"> 只是做一个映射，有时候拿到的对象和我们预想并不能完全一致。</span></span></p></div><div id="https://www.notion.so/4712925597d64d969ea8ff3926b60545" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/f96ee6e9ede54b41aa09a583801590c2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f96ee6e9ede54b41aa09a583801590c2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">隐式转换</span></span></h3><pre id="https://www.notion.so/ac1ffa5d3c744f31ab2b524d62bd2981" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 这里先忽略 timezone 问题</span>
f1 <span class="token operator">=</span> Foo<span class="token punctuation">(</span>created<span class="token operator">=</span><span class="token string">'2020-09-18 09:46:23.544799'</span><span class="token punctuation">)</span>

<span class="token comment"># 字符串会被存储，Django 做了隐式转换</span>
f1<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># str</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>f1<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">)</span>

f2 <span class="token operator">=</span> Foo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>f1<span class="token punctuation">.</span>pk<span class="token punctuation">)</span>

<span class="token comment"># Datetime 对象！</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>f2<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/66918d838b1f477394587d6bf7143434" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/bc92f0cabe6e4152ad65368b097e3954" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过以上的例子就能知道，我们自己创建的内存对象 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f1</code></span><span class="SemanticString"> 和通过 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">orm</code></span><span class="SemanticString"> 拿出来的内存对象 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f2</code></span><span class="SemanticString"> 完全不是同一个东西，虽然他们都可以操作同一条数据库记录，但如果在内存对象里做比较就会有很多问题，比如下面的例子</span></span></p></div><div id="https://www.notion.so/0902500aa1b947d584771b8b80cacd81" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/b08dabe0bc2e4dff991b354ed8a89bef" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/b08dabe0bc2e4dff991b354ed8a89bef"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Mysql 低版本时间精度问题</span></span></h3><pre id="https://www.notion.so/6f628705322d4240b3abfd733b3f5d5e" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    created <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 假定 Foo 表中已经存在了比较多的记录</span>
f <span class="token operator">=</span> Foo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 我们预期是获取按照时间来排序，f 的前一条记录</span>
o <span class="token operator">=</span> Foo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>created_lt<span class="token operator">=</span>f<span class="token punctuation">.</span>created<span class="token punctuation">)</span><span class="token punctuation">.</span>latest<span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">)</span>

<span class="token keyword">assert</span> o<span class="token punctuation">.</span>pk <span class="token operator">==</span> f<span class="token punctuation">.</span>pk
<span class="token comment"># mysql 版本大于 5.6.4 时 -> False</span>
<span class="token comment"># mysql 版本小于 5.6.4 时 -> True</span></span></span></span></code></pre><div id="https://www.notion.so/3ac46b8845474f4fafdd6c240f64e0e0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">原因很简单，当 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">mysql</code></span><span class="SemanticString"> 版本小于 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">5.6.4</code></span><span class="SemanticString"> 时是不支持 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">microseconds</code></span><span class="SemanticString"> 的，由于我们的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f</code></span><span class="SemanticString"> 是内存对象，拿到的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">created</code></span><span class="SemanticString"> 又是有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">microseconds</code></span><span class="SemanticString"> 的，相当于我们在用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">2020-09-18 09:24:38.260779</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">2020-09-18 09:24:38.000000</code></span><span class="SemanticString"> 做比较， </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">o</code></span><span class="SemanticString"> 一直拿到的就是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">f</code></span><span class="SemanticString"> 对应的记录...</span></span></p></div><div id="https://www.notion.so/ebbdf9ec362c4b8e9516856187b32f9c" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F53b61d4b-0742-48a9-ac2c-54311236400f%2FUntitled.png?width=765&amp;table=block&amp;id=ebbdf9ec-362c-4b8e-9516-856187b32f9c"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F53b61d4b-0742-48a9-ac2c-54311236400f%2FUntitled.png?width=765&amp;table=block&amp;id=ebbdf9ec-362c-4b8e-9516-856187b32f9c" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/59a145b036f24843a503802a70de7f9b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/3439f10f660f442a81376effd1df43e2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3439f10f660f442a81376effd1df43e2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">虚假的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.query</code></span></span></h2><div id="https://www.notion.so/1145ecb06d1f4583bfc6672a58ef01c8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/03d2297c79734323b8a722e74648acc5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我们常常用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queryset.query</code></span><span class="SemanticString"> 去检查复杂的查询语句，但实际上 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">query</code></span><span class="SemanticString"> 属性并不能真实反应提交到 DB 中的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sql</code></span><span class="SemanticString"> ，可以参考如下链接：</span></span></p></div><div id="https://www.notion.so/0f3a4e1856ab48549b5bf59c0e7db19b" class="Bookmark"><a href="https://code.djangoproject.com/ticket/17741"><h5 class="Bookmark__Title">QuerySet.query.__str__() does not generate valid MySQL query with dates</h5><p class="Bookmark__Desc">If you have a date parameter in a QuerySet, the string of the query is not valid SQL in MySQL and will generate a warning.</p><p class="Bookmark__Link">https://code.djangoproject.com/ticket/17741</p></a></div><div id="https://www.notion.so/ca6060538984435aaf4f04f044eff891" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ddf4b2136f7e4e43b8052f1261c32d26" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那么如何调试提交到 DB 中的具体语句呢？</span></span></p></div><pre id="https://www.notion.so/5d9c0078b8e04957bdb150f7eb5caf52" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> connection

<span class="token comment"># 在语句提交之后，立即打印</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span>queries<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/334df6c6eb5d4c67a6018cbc5d6b2795" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <div>
    <!-- utterances - Github issue comment -->
    <script src="https://utteranc.es/client.js"
	repo="https://github.com/IMBlues/IMBlues.github.io.git"
	issue-term="pathname"
	label="blog-comment"
	theme="github-light"
	crossorigin="anonymous"
	async>
    </script>
  </div>

  <footer class="Footer">
        <div>&copy; 布鲁斯🐟的奇思乱想 2021</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
  </footer>
</body>

</html>
