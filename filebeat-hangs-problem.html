<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WV23EXEF9X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-WV23EXEF9X');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="FileBeat 启动假死问题">
    <meta property="og:type" content="blog">
  <title>FileBeat 启动假死问题</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="🗿">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>🗿</span> <span>Home</span></div>
    </a>
    <a href="tag/tech.html">
      <div class="Navbar__Btn">♯<span>TECH</span></div>
    </a>
                                                                                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"> <span>关于我</span></div>
    </a>
                                          </nav>
  <header class="Header">
        <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <div class="Header__Icon"><span>🧟‍♂️</span></div>
        <h1 class="Header__Title">FileBeat 启动假死问题</h1>
        <div class="DateTagBar">
            <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, Jun 1, 2021</span>
                  <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
        <a href="tag/ELK.html">ELK</a>
      </span>
            <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
        <a href="tag/best-practice.html">best-practice</a>
      </span>
            <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
        <a href="tag/k8s.html">k8s</a>
      </span>
            <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
        <a href="tag/tech.html">tech</a>
      </span>
          </div>
      </header>
  <article id="https://www.notion.so/499be566e89349b59fcdf8c58d514052" class="PageRoot"><h2 id="https://www.notion.so/a882675bd36c46cd8901c5bf99db0226" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/a882675bd36c46cd8901c5bf99db0226"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">问题</span></span></h2><div id="https://www.notion.so/98ea7a5ebba04e91bbad03c0a08245a2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上周因为 OOM 问题，某个集群内的 Filebeat 被迫重启后，观测了许久，仍不见事件流恢复，查看 Filebeat 输出日志，发现只有其自监控的日志：</span></span></p></div><pre id="https://www.notion.so/3057175968ce45d693d872d722259456" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>2021-05-28T03:19:41.061Z</span></mark></span><span class="SemanticString"><span>	INFO	[monitoring]	log/log.go:145	Non-zero metrics in the last 30s	{&quot;monitoring&quot;: {&quot;metrics&quot;: {&quot;beat&quot;:{&quot;cpu&quot;:{&quot;system&quot;:{&quot;ticks&quot;:6249680,&quot;time&quot;:{&quot;ms&quot;:3024}},&quot;total&quot;:{&quot;ticks&quot;:13659880,&quot;time&quot;:{&quot;ms&quot;:6612},&quot;value&quot;:13659880},&quot;user&quot;:{&quot;ticks&quot;:7410200,&quot;time&quot;:{&quot;ms&quot;:3588}}},&quot;handles&quot;:{&quot;limit&quot;:{&quot;hard&quot;:1048576,&quot;soft&quot;:1048576},&quot;open&quot;:46},&quot;info&quot;:{&quot;ephemeral_id&quot;:&quot;ca641ad8-e10a-496f-a087-6924e456aaea&quot;,&quot;uptime&quot;:{&quot;ms&quot;:60180037}},&quot;memstats&quot;:{&quot;gc_next&quot;:42518272,&quot;memory_alloc&quot;:31026880,&quot;memory_total&quot;:1715304668248,&quot;rss&quot;:-1552384},&quot;runtime&quot;:{&quot;goroutines&quot;:206}},&quot;filebeat&quot;:{&quot;events&quot;:{&quot;added&quot;:139,&quot;done&quot;:139},</span></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>&quot;harvester&quot;:{&quot;open_files&quot;:0,&quot;running&quot;:0}}</span></mark></strong></span><span class="SemanticString"><span>,&quot;libbeat&quot;:{&quot;config&quot;:{&quot;module&quot;:{&quot;running&quot;:0}},&quot;pipeline&quot;:{&quot;clients&quot;:1,&quot;events&quot;:{&quot;active&quot;:1,&quot;filtered&quot;:139,&quot;total&quot;:139},&quot;registrar&quot;:{&quot;states&quot;:{&quot;current&quot;:55084,&quot;update&quot;:13},&quot;writes&quot;:{&quot;success&quot;:139,&quot;total&quot;:139}},&quot;system&quot;:{&quot;load&quot;:{&quot;1&quot;:9.21,&quot;15&quot;:10.97,&quot;5&quot;:10.87,&quot;norm&quot;:{&quot;1&quot;:0.3838,&quot;15&quot;:0.4571,&quot;5&quot;:0.4529}}}}}}</span></span></span></code></pre><div id="https://www.notion.so/cb1b6f7d53af466d8ef1a7b12221e765" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">从 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">&quot;harvester&quot;:{&quot;open_files&quot;:0,&quot;running&quot;:0}}</code></span><span class="SemanticString"> 我们可以判断出  </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">harvester</code></span><span class="SemanticString"> 尚未启动采集，这让我非常疑惑，Filebeat 究竟在做什么？</span></span></p></div><div id="https://www.notion.so/a39d063770e841079d5e858c18830ea0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">接着观察日志，发现除开自监控，最后输出一条日志的内容是：</span></span></p></div><pre id="https://www.notion.so/6780085570e546ca8f35da64dd2c6aad" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>2021-05-28T02:46:39.019Z</span></mark></span><span class="SemanticString"><span>	INFO	beater/crawler.go:73	Loading Inputs: 1</span></span></span></code></pre><div id="https://www.notion.so/07aae701e0be4ce192bc69a16dbfc92a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Loading Inputs</code></span><span class="SemanticString"> 看起来也是符合逻辑的，短时间没有太多的头绪，放下忙其他工作了。</span></span></p></div><div id="https://www.notion.so/e31eabbc4a4e4e3a8a9d2d9f02ed9cc1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">随着时间推移，当我再次观测 Filebeat 时，发现它已经在正常工作了，但是日志内依旧没有错误输出，找到恢复时间点的最早日志：</span></span></p></div><pre id="https://www.notion.so/18feb732a4ea43c0a74de7eb5125f655" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>2021-05-28T05:55:17.822Z</span></mark></span><span class="SemanticString"><span>	INFO	log/input.go:152	Configured paths: [/data/logs/*/*.log* /data/v3logs/*/*/*.log*]
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>2021-05-28T05:55:17.822Z</span></mark></span><span class="SemanticString"><span>	INFO	input/input.go:114	Starting input of type: log; ID: 3062577341473220485
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><span>2021-05-28T05:55:17.822Z</span></mark></span><span class="SemanticString"><span>	INFO	beater/crawler.go:105	Loading and starting Inputs completed. Enabled inputs: 1</span></span></span></code></pre><div id="https://www.notion.so/82ae35ced1af4abeb0c22c13a812356f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">好家伙，从 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Loading Inputs</code></span><span class="SemanticString"> → </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Loading and starting Inputs completed</code></span><span class="SemanticString"> 花费了3个多小时，这更让我疑惑了，Filebeat 究竟为什么一直装死？</span></span></p></div><h2 id="https://www.notion.so/d6a1635c01224b16b172be93be8da9fa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d6a1635c01224b16b172be93be8da9fa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">原因</span></span></h2><div id="https://www.notion.so/ecbef247cc844388be3e09bc8bb997da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">根据日志打印翻阅了 Filebeat 源码</span></span></p></div><div id="https://www.notion.so/885f8e2b96b2437c88d50d4698476c4e" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc55eecdf-b786-4a27-8d0a-af5a9f355d59%2FUntitled.png?width=1338&amp;table=block&amp;id=885f8e2b-96b2-437c-88d5-0d4698476c4e"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc55eecdf-b786-4a27-8d0a-af5a9f355d59%2FUntitled.png?width=1338&amp;table=block&amp;id=885f8e2b-96b2-437c-88d5-0d4698476c4e" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/elastic/beats/blob/23e4403ae093fcc8f7905345cad2c7ad256976d8/filebeat/beater/crawler.go#L71">https://github.com/elastic/beats/blob/23e4403ae093fcc8f7905345cad2c7ad256976d8/filebeat/beater/crawler.go#L71</a></span></span></figcaption></figure></div><div id="https://www.notion.so/788a3f000b664da4abba183daea63111" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fff54b1b7-4b7d-4054-9a17-0e073d4820bb%2FUntitled.png?width=1516&amp;table=block&amp;id=788a3f00-0b66-4da4-abba-183daea63111"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fff54b1b7-4b7d-4054-9a17-0e073d4820bb%2FUntitled.png?width=1516&amp;table=block&amp;id=788a3f00-0b66-4da4-abba-183daea63111" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/elastic/beats/blob/2ee21d95aef89af7f7e7aef8d07f679a24d690b4/filebeat/registrar/registrar.go#L172">https://github.com/elastic/beats/blob/2ee21d95aef89af7f7e7aef8d07f679a24d690b4/filebeat/registrar/registrar.go#L172</a></span></span></figcaption></figure></div><div id="https://www.notion.so/97e110c2498d41d09cd5b20d2c3bce3d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Filebeat 使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">registry file</code></span><span class="SemanticString"> 作为采集的状态存储，实际上就是一个纯文本的 JSON 文件。每次启动时都会检查 JSON 文件中的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">states</code></span><span class="SemanticString"> 是否需要更新（新增或者删除文件），而当任何一个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">state</code></span><span class="SemanticString"> 需要更新， </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">registry file</code></span><span class="SemanticString"> 将会全量序列化(读) → 持久化(写)，随着 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">states</code></span><span class="SemanticString"> 越来越多，JSON 文件会越来越大（接近20MB），每次全量读写都会越来越慢，并且 CPU、内存的使用量都会暴涨。</span></span></p></div><div id="https://www.notion.so/02195aab40d04c79aee439fb3a1afc35" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb20f6619-c30b-4392-85ae-fd16c4ca5296%2FUntitled.png?width=1856&amp;table=block&amp;id=02195aab-40d0-4c79-aee4-39fb3a1afc35"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb20f6619-c30b-4392-85ae-fd16c4ca5296%2FUntitled.png?width=1856&amp;table=block&amp;id=02195aab-40d0-4c79-aee4-39fb3a1afc35" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/78e9e85e079743aeb05610b4ead6c3ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/48a4f3303abd4fb5aa7426cc8b3565a6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a84a6b3b5bdc40bd93b9da7af7045776" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">总的来说，在当前的数据存储选型下，Filebeat 无法应对过多的文件数据数量，启动时的数据核验时间过长（几小时→几天不等，视数据量而定），就会产生了“假死”的现象。</span></span></p></div><h2 id="https://www.notion.so/dd9f1916ef7a4e33b25f51e4e3e0801a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/dd9f1916ef7a4e33b25f51e4e3e0801a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">解决方案</span></span></h2><h3 id="https://www.notion.so/6379934601534cc4ad3c5f87de1399fd" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/6379934601534cc4ad3c5f87de1399fd"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">临时的解决方案</span></span></h3><div id="https://www.notion.so/410ac392208b44fcb5a3b00e09bbf05c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">暂停 Filebeat 进程，删除 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">registry file</code></span><span class="SemanticString"> ，重启 Filebeat 进程。这时候由于 JSON 文件是比较小的，所有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">state</code></span><span class="SemanticString"> 均处于增量状态，数据同步是比较快的。但是所有已经发送过的事件将难以</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">避免地重复发送一次，</strong></span><span class="SemanticString">所以这种做法只能应急，不能长久处理。</span></span></p></div><div id="https://www.notion.so/7cdd2e0a484e46e79ebc96d55fa7831e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/144cf4ebaee643928b441199d7ebce9f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/144cf4ebaee643928b441199d7ebce9f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">长久的权宜之计</span></span></h3><div id="https://www.notion.so/c5fdcec55a4f4485b8caed5c019677d2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Filebeat 的纯文本的 JSON 存储选型天生就是存在问题的，社区内也曾做过一些</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/elastic/beats/pull/12908">小改进的尝试</a></span><span class="SemanticString">，最终并没有被合并到柱分枝。所以 Filebeat 无法应用过多的日志文件，这是一个短期内无法改变的事实。</span></span></p></div><div id="https://www.notion.so/99979f8d51a543aab4d4be6181c241c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9ed3fbd8dce146daa132e34f6b5b6f54" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">而在当前选择的</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://emergencyexit.xyz/elk-back-pressure-study.html">依赖背压的采集方案</a></span><span class="SemanticString"> 中，我们并不倾向将日志文件留在采集管道中，而是将日志留在原处——机器的磁盘上，然后尽量保证管道的通畅，将日志实时采集到 ES 中。</span></span></p></div><div id="https://www.notion.so/cb547396cd544ca8867868fc2ee54ac2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这样做的好处，就是避免因为过多的管道传输导致日志丢失（例如 Redis 写满后崩溃）。</span></span></p></div><div id="https://www.notion.so/c9b272b308ea4cc1960793e95c27adae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">同时也会引入另一个问题：如果采集链路阻塞，同时过多的日志（采集条目每日2亿+）大于机器的磁盘承载能力时，日志丢失的风险依旧存在。</span></span></p></div><div id="https://www.notion.so/ff21f66c56f243cc94d8831be8360296" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">所以我们需要定期清理过期的日志，但问题也没那么简单：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/754d5b66c16b436ab0e18c4ec1f7c033" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">直接删除日志文件  → 写日志的</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://stackoverflow.com/a/2031100/6122939">应用进程无法感知，将向无效文件句柄写日志</a></span><span class="SemanticString"> → 导致日志丢失</span></span></li><li id="https://www.notion.so/5901f55cb66845508597ecc8c609561b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">清空文件日志内容( </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">echo &#x27;&#x27; &gt; {}</code></span><span class="SemanticString">) → 导致文件数量不会减少</span></span></li><li id="https://www.notion.so/47658edd2bc64cb185b4f4d41cc19bd2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果因为硬盘容量限制，删除日志的周期小于</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">产品许诺的日志保存时长</em></span><span class="SemanticString">，当链路出现堵塞又未能及时处理 → 导致日志丢失</span></span></li></ul><div id="https://www.notion.so/c5eb4e35c1564042b36fb81089fa4505" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/eff219afa97e440da125d070b354d27b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">所以我写了一个 </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://gist.github.com/IMBlues/2803c02420d01309d33f9d26ee501223">删除脚本</a></span><span class="SemanticString">，在保证清理过期日志的同时，会判断日志文件的句柄使用情况，跳过那些仍在被写入的文件，保证日志不丢失。</span></span></p></div><pre id="https://www.notion.so/963f78e8692f45d594cd80b45a986941" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> getopt
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Generator<span class="token punctuation">,</span> Dict

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>


Process <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">"Process"</span><span class="token punctuation">,</span> <span class="token string">"command,pid,user"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_processes_open</span><span class="token punctuation">(</span>file_regex<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Process<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Find processes with open handles for the specified file(s)."""</span>

    open_file_process_map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># maybe not safe</span>
        output <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>getoutput<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"echo </span><span class="token interpolation"><span class="token punctuation">{</span>file_regex<span class="token punctuation">}</span></span><span class="token string"> | xargs lsof"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">"exec error"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> open_file_process_map

    lines <span class="token operator">=</span> output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
        parts <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">]</span>
        open_file_process_map<span class="token punctuation">[</span>parts<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Process<span class="token punctuation">(</span><span class="token operator">*</span>parts<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> open_file_process_map


<span class="token keyword">def</span> <span class="token function">try_to_delete_files</span><span class="token punctuation">(</span>file_regex<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Try to delete files"""</span>
    skipped_count <span class="token operator">=</span> deleted_count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">filter_files_by_expire_minutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Generator<span class="token punctuation">[</span>Path<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Get all expired files"""</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>file_regex<span class="token punctuation">,</span> recursive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_obj <span class="token operator">=</span> Path<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            updated <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>file_obj<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_mtime<span class="token punctuation">)</span>
            <span class="token keyword">if</span> updated <span class="token operator">&lt;</span> now <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span>minutes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">yield</span> file_obj

    open_file_process_map <span class="token operator">=</span> get_processes_open<span class="token punctuation">(</span>file_regex<span class="token punctuation">)</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> filter_files_by_expire_minutes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> open_file_process_map<span class="token punctuation">:</span>
            deleted_count <span class="token operator">+=</span> <span class="token number">1</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"deleting </span><span class="token interpolation"><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            skipped_count <span class="token operator">+=</span> <span class="token number">1</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"skipping </span><span class="token interpolation"><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span><span class="token string">, for process: </span><span class="token interpolation"><span class="token punctuation">{</span>open_file_process_map<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Skipped: </span><span class="token interpolation"><span class="token punctuation">{</span>skipped_count<span class="token punctuation">}</span></span><span class="token string">, deleted: </span><span class="token interpolation"><span class="token punctuation">{</span>deleted_count<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        opts<span class="token punctuation">,</span> args <span class="token operator">=</span> getopt<span class="token punctuation">.</span>getopt<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"hf:m:"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"files="</span><span class="token punctuation">,</span> <span class="token string">"minutes="</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> getopt<span class="token punctuation">.</span>GetoptError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Example: python delete_files.py -f /data/*/*.log* -m 1440"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    arg_files <span class="token operator">=</span> <span class="token string">""</span>
    arg_minutes <span class="token operator">=</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span>
    <span class="token keyword">for</span> opt<span class="token punctuation">,</span> arg <span class="token keyword">in</span> opts<span class="token punctuation">:</span>
        <span class="token keyword">if</span> opt <span class="token operator">==</span> <span class="token string">"-h"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: python delete_files.py -f /data/*/*.log* -m 1440"</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> opt <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"--files"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            arg_files <span class="token operator">=</span> arg
        <span class="token keyword">elif</span> opt <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">"-m"</span><span class="token punctuation">,</span> <span class="token string">"--minutes"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            arg_minutes <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>

    started <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Started: </span><span class="token interpolation"><span class="token punctuation">{</span>started<span class="token punctuation">}</span></span><span class="token string">\n>>>>>>>>>>>>"</span></span><span class="token punctuation">)</span>
    try_to_delete_files<span class="token punctuation">(</span>arg_files<span class="token punctuation">,</span> arg_minutes<span class="token punctuation">)</span>
    finished <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>
        <span class="token string-interpolation"><span class="token string">f">>>>>>>>>>>>\nFinished: </span><span class="token interpolation"><span class="token punctuation">{</span>finished<span class="token punctuation">}</span></span><span class="token string">, total cost: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">(</span>finished <span class="token operator">-</span> started<span class="token punctuation">)</span><span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> seconds \n"</span></span>
    <span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/648976fdacc34f18a08b6a35f8a62273" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当然你也可以根据需求用 Bash 实现，这里就不展开了。</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><del class="SemanticString__Fragment SemanticString__Fragment--Strike">（其实就是我不会 Bash）</del></em></span></span></p></div><div id="https://www.notion.so/9dd6e683c9a34f9fb7233d6d177af402" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/41199e35ed9e4ab485a23d605aee205a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">然后我们需要将它跑在集群中的每一个节点上，定期执行清理工作：</span></span></p></div><div id="https://www.notion.so/b14e60ead37f4b8faeb98eef9d4b1d50" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先定义镜像</span></span></p></div><pre id="https://www.notion.so/4ed2fdef58dc4c5e97431ca3cc1602b6" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3
<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y lsof
<span class="token keyword">ADD</span> delete_files.py /
<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"./delete_files.py"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"./*.no"</span><span class="token punctuation">,</span> <span class="token string">"-m"</span><span class="token punctuation">,</span> <span class="token string">"1440"</span> <span class="token punctuation">]</span></span></span></span></code></pre><div id="https://www.notion.so/cc1407ee77c24617bb68d7e29f6fd019" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8d48b9673ce24a62b2d363c4ea30e623" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Kubernetes DaemonSet 定义，在每一个节点上都尝试清理日志：</span></span></p></div><pre id="https://www.notion.so/aef77ad9412a401780b8e88d3d34b783" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>cleaner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>cleaner
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>cleaner
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>cleaner
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>cleaner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> batch<span class="token punctuation">-</span>delete<span class="token punctuation">-</span>files
        <span class="token key atrule">image</span><span class="token punctuation">:</span> some<span class="token punctuation">-</span>registry/batch<span class="token punctuation">-</span>delete<span class="token punctuation">-</span>files<span class="token punctuation">:</span>v1.0.0
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bash"</span><span class="token punctuation">]</span>
        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"while true; do python delete_files.py -f /some-path/*/*/*.log* -m 1440; sleep 3600; done;"</span><span class="token punctuation">]</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 2560m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 25m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 32Mi
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /some<span class="token punctuation">-</span>path/
          <span class="token key atrule">name</span><span class="token punctuation">:</span> some<span class="token punctuation">-</span>volume
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> some<span class="token punctuation">-</span>volume
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /some<span class="token punctuation">-</span>path/</span></span></span></code></pre><div id="https://www.notion.so/343f4de7fd284715869ba250863363b9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">值得注意的是，由于我们需要在容器内使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lsof</code></span><span class="SemanticString"> 来看查看母机文件的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fd</code></span><span class="SemanticString"> 使用情况，所以这里需要额外添加 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hostPID: true</code></span><span class="SemanticString"> 来保证能够读取到母机的进程信息。</span></span></p></div><div id="https://www.notion.so/b0baaca6488745dd830ac188476795b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">由于我们需要定时执行，所以通过 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">while true; do ... sleep 3600; done;</code></span><span class="SemanticString"> 来要额外控制执行周期。</span></span></p></div><div id="https://www.notion.so/87b47311de6e49fc8782a1849a52726f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/429fd6a243ec42f79e085f33fd1a9c6a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/429fd6a243ec42f79e085f33fd1a9c6a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">结语</span></span></h2><div id="https://www.notion.so/cd51a58653374cfea15a71218075e2d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">由于 Filebeat 存在天生的存储缺陷，我们需要通过额外的脚本较为精确的控制 Filebeat 的输入文件数量，当前的方案断然达不到完善，仍需要我们继续探索。</span></span></p></div><div id="https://www.notion.so/3e21828982d54b07aec86741411dd19d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/e0e27b64f17b469e83a7050d462387b4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参考：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/9ee3478ccdd349e9af623759e1aa9e58" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/elastic/beats/issues/16076">https://github.com/elastic/beats/issues/16076</a></span></span></li><li id="https://www.notion.so/6d4fe61f85cc45d28d095e96e65f402f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://stackoverflow.com/questions/36186630/python-error-subprocess-calledprocesserror-command-returned-non-zero-exit-stat">https://stackoverflow.com/questions/36186630/python-error-subprocess-calledprocesserror-command-returned-non-zero-exit-stat</a></span></span></li><li id="https://www.notion.so/c575830d6d1144d7a532fde4b938913b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://stackoverflow.com/questions/55901375/is-this-possible-to-schedule-cronjob-to-execute-on-each-of-kubernetes-nodes">https://stackoverflow.com/questions/55901375/is-this-possible-to-schedule-cronjob-to-execute-on-each-of-kubernetes-nodes</a></span></span></li></ul><div id="https://www.notion.so/d3bdd3c282044e51834bb510ab28a4b6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <div>
    <!-- utterances - Github issue comment -->
    <script src="https://utteranc.es/client.js" repo="IMBlues/IMBlues.github.io" issue-term="pathname"
      label="blog-comment" theme="github-light" crossorigin="anonymous" async>
      </script>
  </div>

  <footer class="Footer">
    <div>&copy; 布鲁斯🐟的奇思乱想 2021</div>
    <div>&centerdot;</div>
    <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
        rel="noopener noreferrer">Notablog</a>.
    </div>
  </footer>
</body>

</html>