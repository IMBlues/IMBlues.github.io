<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F66ae2268-69fb-4a91-a4a8-fea3ba4543a5%2Fbluesyu.png?table=collection&amp;id=12c44699-617b-45ed-a019-c3b075e0ae01">

<style>
  :root {
    font-size: 20px;
  }
</style>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WV23EXEF9X"></script>
<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-WV23EXEF9X');
</script>

  <title>ReDoS：正则也许会让你的系统更脆弱&nbsp;|&nbsp;布鲁斯🐟的奇思乱想</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="ReDoS：正则也许会让你的系统更脆弱">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😈&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F66ae2268-69fb-4a91-a4a8-fea3ba4543a5%2Fbluesyu.png?table=collection&amp;id=12c44699-617b-45ed-a019-c3b075e0ae01"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3a9bcf6a-f4f8-4580-93a6-b21a38a8914b%2F988431636594419_.pic.jpg?table=block&amp;id=78f0b500-97be-4b05-ad6d-630418880655"></span>&nbsp;
          
          <span>关于我</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://images.unsplash.com/photo-1508935620299-047e0e35fbe3?ixlib=rb-1.2.1&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😈&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">ReDoS：正则也许会让你的系统更脆弱</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, Mar 1, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
            <a href="tag/python.html">python</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--default">
            <a href="tag/tech.html">tech</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/regex.html">regex</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--brown">
            <a href="tag/nfa.html">nfa</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/dfa.html">dfa</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/652406abd41041e4afa497957b070d0e" class="PageRoot"><ul id="https://www.notion.so/dd7eca0b1d8e415585ab18307901f01f" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/8e10ba1fc1414080886351ff7c2d97a4"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">引</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d09102f8fdbd4b76adaff6505ac2a83e"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Evil Regex 大敌当前</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/aec28d8fa17546419c6650761911f319"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">知己知彼，百战不殆</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/5b9d1177f1814c079459c2e57c447583"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">NFA vs DFA</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/fbfe04ee36bd49adb19ac28297f241d5"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Thompson NFA 构造 vs DFA</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cd4955ae21b44a219073b53e27a0ce0c"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">为什么主流编程语言这么慢？</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cd33fbd35ec2402fba71bb55a44db458"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">正面对抗 Evil Regex</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9b807a3d6a4f4382a8ca9a32a39082b9"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">pyre2</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/843bd650503c440b9f1d67b62c86b850"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">regex</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/a0e77fa2bc7b4b6fa5b0b831e7132498"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></div></a></li></ul><h2 id="https://www.notion.so/8e10ba1fc1414080886351ff7c2d97a4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/8e10ba1fc1414080886351ff7c2d97a4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">引</span></span></h2><div id="https://www.notion.so/8031381f26bb4cc3826d07c7ab0b5cb7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里有一段看起来稀松平常、人畜无害的 Python 代码，你可以试着执行一下：</span></span></p></div><pre id="https://www.notion.so/26963e9b9d014e1abec21c8dae3a2656" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> re
<span class="token keyword">import</span> time


value <span class="token operator">=</span> <span class="token string">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaabs"</span>
strange_regex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">"(a+)+s"</span><span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>strange_regex<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/e9b3629a3a2b45a68d3ed9d6a7307773" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不知道大家执行了多久，在我开发机上使用 Python 3.6+（包括 3.10.x）</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">需要耗费20秒以上</strong></span><span class="SemanticString">，即使 CPU ——Apple M1 Pro 的性能已经相当强悍了。</span></span></p></div><div id="https://www.notion.so/6b65cd5e48624fe0a575335da2a7f3f0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以试想一下，如果在生产环境服务的关键请求链路中存在这样正则匹配，加上不可控的用户输入，很容易落入“性能陷阱”，轻则拖慢系统，重则直接让服务暴露在 </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/ReDoS">ReDoS</a></span><span class="SemanticString"> (Regual Expression Denial-of-Service) 的风险之下。</span></span></p></div><div id="https://www.notion.so/2b4594a59d324f87be8b7ca6c74838e3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">随手一搜，已经有不少相关的案例发生：</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23343">CVE-2021-23343</a></span><span class="SemanticString"> 、</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41817">CVE-2021-41817</a></span><span class="SemanticString">。所以，它值得我们格外重视。</span></span></p></div><h2 id="https://www.notion.so/d09102f8fdbd4b76adaff6505ac2a83e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/d09102f8fdbd4b76adaff6505ac2a83e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Evil Regex 大敌当前</span></span></h2><div id="https://www.notion.so/20027492dc464316ac426aaaf37012e7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">先来看一些和上面例子类似的、典型的邪恶正则：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/aecbafe07e3643b1bdc900a39ab3c3e3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a+)+</code></span></span></li><li id="https://www.notion.so/c5b7434112564198b67486bf866efd6c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">([a-zA-Z]+)*</code></span></span></li><li id="https://www.notion.so/372b3bccb0364e6ea4f800e053d09449" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a|aa)+</code></span></span></li><li id="https://www.notion.so/c2cef2bd0ea84b31b29627c8261c6ccc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a|a?)+</code></span></span></li><li id="https://www.notion.so/df166bba61a04689a436dfae40ee2576" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a|a)+$</code></span></span></li><li id="https://www.notion.so/12c5ac34652846468ad19eba89806e90" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(.*a){x} for x \&gt; 10</code></span></span></li></ul><div id="https://www.notion.so/c02908f21dbf4826a2f040d114e63385" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">它们都有共同的一些特点：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/d386087c26b1432d8f2aa08b7f720b36" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">存在子表达重复——形如 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">()+</code></span><span class="SemanticString"> 、 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">()*</code></span></span></li><li id="https://www.notion.so/24a86d1252674979b94be7b469464b4e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在重复的子表达中：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/95331231fa2e4ca19877576aabf0ac54" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">存在重复项—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a+)+</code></span></span></li><li id="https://www.notion.so/35de14baac4948fbbd8e27c74ed3f922" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">存在交替重复—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a|aa)+</code></span></span></li></ul></li><li id="https://www.notion.so/e487746d47124d42aa6c857cf5b26df9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在重复的子表达的末尾，存在一个子表达式无法匹配的内容，例如 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(a|a)+$</code></span></span></li></ul><div id="https://www.notion.so/af4e12277bc24c68ba77c14c784f5078" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那么为什么这些重复会导致匹配速度如此之慢呢？我们要看看正则的具体实现思路。</span></span></p></div><h2 id="https://www.notion.so/aec28d8fa17546419c6650761911f319" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/aec28d8fa17546419c6650761911f319"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">知己知彼，百战不殆</span></span></h2><div id="https://www.notion.so/ac0d51e20acc46ffa4c434d208f09a9b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当前主流语言的正则实现机制都是构建</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/Nondeterministic_finite_automaton"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">非确定有限状态自动机(NFA)</strong></a></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"> </strong></span><span class="SemanticString">，相较于</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/Deterministic_finite_automaton"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">确定有限状态自动机(DFA)</strong></a></span><span class="SemanticString">，前者会使用</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/Backtracking">回溯法(backtracking)</a></span><span class="SemanticString">，这也是导致邪恶正则存在的根因。</span></span></p></div><h3 id="https://www.notion.so/5b9d1177f1814c079459c2e57c447583" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/5b9d1177f1814c079459c2e57c447583"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">NFA vs DFA</span></span></h3><div id="https://www.notion.so/6cf4868e98b7464b85a8ae4a702e4963" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">（该章节中的图例均来自</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://swtch.com/~rsc/regexp/regexp1.html">这篇文章</a></span><span class="SemanticString">，我在这里做了内容简化，建议有兴趣的同学阅读英文原文）</span></span></p></div><div id="https://www.notion.so/af1ea1b0fd0a43d4bdfc8d587bc754c1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">FA 有限自动机，又称 FSM 有限状态机，在当前的语境下，我们统一都是用 FA 来描述。这种计算模型比较常见，所以我们就着重关注 NFA 和 DFA 的对比。</span></span></p></div><div id="https://www.notion.so/485cbdbe64914b79b253201746be514d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首先，来看一个简单的正则表达式—— </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">a(bb)+a</code></span><span class="SemanticString"> ，它可以转换成以下两种表达：</span></span></p></div><div id="https://www.notion.so/16def40beb9c4a6f8401a706e0b46bff" class="ColumnList"><div id="https://www.notion.so/50d97ae8185b4a17a2fb29ad9fdd3e0a" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/2c378c6b213b48d28d065652a0a5187f" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe41cc1a4-ae04-422e-8a4d-22e77e03d496%2FUntitled.png?width=288&amp;table=block&amp;id=2c378c6b-213b-48d2-8d06-5652a0a5187f"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe41cc1a4-ae04-422e-8a4d-22e77e03d496%2FUntitled.png?width=288&amp;table=block&amp;id=2c378c6b-213b-48d2-8d06-5652a0a5187f" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">DFA</span></span></figcaption></figure></div></div><div id="https://www.notion.so/6e769df7457e459fa7c53565ae29677d" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/044ad270ea524ddf882571d037f54dc8" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F18765429-1c82-4046-9afe-21a3a68d505d%2FUntitled.png?width=288&amp;table=block&amp;id=044ad270-ea52-4ddf-8825-71d037f54dc8"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F18765429-1c82-4046-9afe-21a3a68d505d%2FUntitled.png?width=288&amp;table=block&amp;id=044ad270-ea52-4ddf-8825-71d037f54dc8" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">NFA</span></span></figcaption></figure></div></div></div><div id="https://www.notion.so/d4652ed774db442681b8a81ab44856c8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">上面两张图能够很清晰地表现出二者的不同：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/06ff70ca8c4e417292b79992473ef8fe" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">DFA 中，每一个状态在接收到输入时，下一个状态都是确定的。</span></span></li><li id="https://www.notion.so/e6a44c255c6a47048cd3b36a9f094037" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">NFA 中，存在某些状态在接收到输入时，无法确定下一个状态：例如图中的 S2 接收到字符 b，S1 和 S3 都是可能的下一个状态。所以系统在分支选择时，需要进行猜测。</span></span></li></ul><div id="https://www.notion.so/1703f687faa7452c849d60e0edf01ff5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">理论上，每一条正则表达式都可以等同转换成一个 NFA 状态机，那么如果使用 NFA 进行匹配，如何处理猜测分支就很重要了。下面我们来看一个简单遍历猜测的例子。</span></span></p></div><div id="https://www.notion.so/4ea4a9146bf24d36ae0e965e14b7cb24" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">根据正则 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">abab|abbb</code></span><span class="SemanticString"> 我们可以建立如下的 NFA：</span></span></p></div><div id="https://www.notion.so/6c75172bdd20472b907ce18f1bc28865" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F100299f6-ef9d-41f6-b77c-dfbcb1644614%2FUntitled.png?width=364&amp;table=block&amp;id=6c75172b-dd20-472b-907c-e18f1bc28865"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F100299f6-ef9d-41f6-b77c-dfbcb1644614%2FUntitled.png?width=364&amp;table=block&amp;id=6c75172b-dd20-472b-907c-e18f1bc28865" style="width:364px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e4445b9868ad4c1da6b7018c8d5c2d8c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">模拟计算机匹配输入 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">abbb</code></span><span class="SemanticString">，可以有如下两种路径：</span></span></p></div><div id="https://www.notion.so/4d2c72fea4fc4bf4b41a46ebd2cd1051" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2d01c07f-0cde-40f3-8ad1-837137c1d9d8%2FUntitled.png?width=729&amp;table=block&amp;id=4d2c72fe-a4fc-4bf4-b41a-46ebd2cd1051"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2d01c07f-0cde-40f3-8ad1-837137c1d9d8%2FUntitled.png?width=729&amp;table=block&amp;id=4d2c72fe-a4fc-4bf4-b41a-46ebd2cd1051" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e83e4c75d5e849c3b4834d81c38936d6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以 Step 0 开始的路径，在匹配到第三个字符时出错，此时不得不采用回溯，再次从一开始进行匹配，即 Step 4 → Step 8。</span></span></p></div><div id="https://www.notion.so/de729f7cc175476ba313cc388b6aa1d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过这个回溯方法，我们来思考正则表达式 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="a?^{n}a^{n}"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><msup><mo stretchy="false">?</mo><mi>n</mi></msup><msup><mi>a</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">a?^{n}a^{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mclose"><span class="mclose">?</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="SemanticString"> 与字符串 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="a^{n}"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">a^{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.664392em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="SemanticString"> 匹配：</span></span></p></div><div id="https://www.notion.so/1a747638ee6a4256b7e3d9b47eaaf08b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果每一次判断 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="a"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span></span></span></span></span></span><span class="SemanticString"> 是否存在时，都会尝试匹配“存在”的情况，再匹配不存在的情况，而整个字符串长度为 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="n"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span></span></span><span class="SemanticString">，也就是时间复杂度为  </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="O(2^{n})"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(2^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/e57f4817142c439482418cab9bbfe7e3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当前主流的语言（Perl, PCRE, Python, Ruby等）采用了</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">递归</strong></span><span class="SemanticString">来实现深度优先回溯，相较于 </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/Thompson%27s_construction">Thompson NFA</a></span><span class="SemanticString">，最终实现的效果都是惊人的糟糕。</span></span></p></div><div id="https://www.notion.so/2b1581c6aec5442f8595bad7a30c99be" class="ColumnList"><div id="https://www.notion.so/3fa3ac1de7b349d3a9a570efb24c01cf" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/a99257586efb4435baa19f0f79be1090" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F62d6c97a-651f-4dae-9157-3711b51864ef%2FUntitled.png?width=301&amp;table=block&amp;id=a9925758-6efb-4435-baa1-9f0f79be1090"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F62d6c97a-651f-4dae-9157-3711b51864ef%2FUntitled.png?width=301&amp;table=block&amp;id=a9925758-6efb-4435-baa1-9f0f79be1090" style="width:301px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></div><div id="https://www.notion.so/dfbbc6fac05b4146bd018f5639281000" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/d43cd71c06774c479bb5f8e5479a3835" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc1b2f543-8d54-4deb-be08-868bc57b76b6%2FUntitled.png?width=302&amp;table=block&amp;id=d43cd71c-0677-4c47-9bb5-f8e5479a3835"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc1b2f543-8d54-4deb-be08-868bc57b76b6%2FUntitled.png?width=302&amp;table=block&amp;id=d43cd71c-0677-4c47-9bb5-f8e5479a3835" style="width:302px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></div></div><h3 id="https://www.notion.so/fbfe04ee36bd49adb19ac28297f241d5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/fbfe04ee36bd49adb19ac28297f241d5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Thompson NFA 构造 vs DFA</span></span></h3><div id="https://www.notion.so/91792015d92e4f5bb5de9e61e268ff8c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为什么使用了 Thompson NFA 构造出的正则匹配会快这么多呢？主要的原因是：通过划分多个子表达式，合并相同的内容，从而减少了回溯次数。</span></span></p></div><div id="https://www.notion.so/a54e246b166a47ceaded30606a52bb8e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="(ε|a*b)"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>ε</mi><mi mathvariant="normal">∣</mi><mi>a</mi><mo>∗</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(ε|a*b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">ε</span><span class="mord">∣</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span></span></span><span class="SemanticString"> 可以转换成 Thompson 构造，图示：</span></span></p></div><div id="https://www.notion.so/81c99199b98843399e229a6a5c60c220" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F72c2591d-be7f-4f93-b93b-30904f2f6b6c%2FUntitled.png?width=888&amp;table=block&amp;id=81c99199-b988-4339-9e22-9a6a5c60c220"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F72c2591d-be7f-4f93-b93b-30904f2f6b6c%2FUntitled.png?width=888&amp;table=block&amp;id=81c99199-b988-4339-9e22-9a6a5c60c220" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/361fa823a77f4e0881ff8a1438142351" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">稍微做一些解释：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/082443e0142147ba97b24d8b3db33d93" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">q 是开始，f 是结束，白圈是状态，连线是流转</span></span></li><li id="https://www.notion.so/fb844b11e9f04b4d9a76d3c3863031c5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">ε 代表着无输入</span></span></li></ul><div id="https://www.notion.so/ed5b795db13844f0b5019316c0c1f2a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">通过以上的结构，Thompson NFA 匹配的时间复杂度为  </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="O(n)"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></span><span class="SemanticString">，空间复杂度为</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="O(n^{2})"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^{2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/78bb109f3b6340c89250f512dd678481" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b1ceeaab59d641c6841a2eb34c800f4c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">而 DFA 更容易理解，因为它是典型的空间换时间。</span></span></p></div><div id="https://www.notion.so/7e99a7cb3a5c4d6ca3d2054b7a27c55e" class="ColumnList"><div id="https://www.notion.so/08971a6c0e9d45c0b9a86a61ad4269e9" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/9af5e7e51fb9445981cda193a870595a" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7febb121-726d-47a6-80c5-9351397addd6%2FUntitled.png?width=424&amp;table=block&amp;id=9af5e7e5-1fb9-4459-81cd-a193a870595a"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7febb121-726d-47a6-80c5-9351397addd6%2FUntitled.png?width=424&amp;table=block&amp;id=9af5e7e5-1fb9-4459-81cd-a193a870595a" style="width:424px"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">NFA</span></span></figcaption></figure></div></div><div id="https://www.notion.so/44737c0663c043ed9d796493526a127a" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/fcf6aa9b6ea54ee19ac200c455f9d131" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F903b942f-49b7-4953-923c-55fb6d520bd5%2FUntitled.png?width=496&amp;table=block&amp;id=fcf6aa9b-6ea5-4ee1-9ac2-00c455f9d131"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F903b942f-49b7-4953-923c-55fb6d520bd5%2FUntitled.png?width=496&amp;table=block&amp;id=fcf6aa9b-6ea5-4ee1-9ac2-00c455f9d131" style="width:496px"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">DFA</span></span></figcaption></figure></div></div></div><div id="https://www.notion.so/96829f3a5e5640b08ba86e6b5814c387" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以看到每一个 DFA 的状态都等同于某一时刻 NFA 状态列表，所以 DFA 在最坏情况下，空间复杂度 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="O(2^{n})"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(2^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span><span class="SemanticString">，也会在构建阶段消耗更多时间。同时没有了回溯，整个匹配时间就是字符串长度，复杂度为 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="O(n)"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></span><span class="SemanticString">。为了保证 DFA 的空间消耗，一般都会额外对构建出的 </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikipedia.org/wiki/DFA_minimization">DFA 做简化</a></span><span class="SemanticString">，减少图的大小。</span></span></p></div><h3 id="https://www.notion.so/cd4955ae21b44a219073b53e27a0ce0c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/cd4955ae21b44a219073b53e27a0ce0c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">为什么主流编程语言这么慢？</span></span></h3><div id="https://www.notion.so/5a46274cde5447f3a8d1f0906c7475cc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">说来有趣，Thompson NFA 构造法应该是编译原理的基础概念，DFA 方法从概念上也是比较简单，为什么当前的主流语言没有采用，反而采用了一个带有回溯的、效果远逊的版本？</span></span></p></div><div id="https://www.notion.so/38e9610dde8f47b9b12809fa5e2c81eb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">经过一番冲浪搜索，简单概括我找到的结论：</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">历史的局限</strong></span><span class="SemanticString">。</span></span></p></div><blockquote id="https://www.notion.so/c2be458c6ee44872a3a160bd306ab855" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">While writing the text editor sam [6] in the early 1980s, Rob Pike wrote a new regular expression implementation, which Dave Presotto extracted into a library that appeared in the Eighth Edition. Pike&#x27;s implementation incorporated submatch tracking into an efficient NFA simulation but, like the rest of the Eighth Edition source, was not widely distributed. Pike himself did not realize that his technique was anything new. </em></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Henry Spencer reimplemented the Eighth Edition library interface from scratch, but using backtracking, and released his implementation into the public domain.</em></mark></span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"> </em></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorRed"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">It became very widely used, eventually serving as the basis for the slow regular expression implementations mentioned earlier: Perl, PCRE, Python, and so on.</em></mark></span></span></blockquote><div id="https://www.notion.so/e00a8ab3f15040ac98210a737bd80995" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以从上文得知，正则匹配的实现首先需要兼容原来的使用方式，而当时开发者并未了解 NFA 模拟方法，而是自己从零实现了一个回溯方法，并且被广泛地传播开了。即使这个实现很慢，但是由于已经被大规模采用，且能满足大多数的使用场景，各个主流语言也没有替换它。</span></span></p></div><h2 id="https://www.notion.so/cd33fbd35ec2402fba71bb55a44db458" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cd33fbd35ec2402fba71bb55a44db458"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">正面对抗 Evil Regex</span></span></h2><div id="https://www.notion.so/6d78b2acd7b14f6595ef22c4d692562d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">既然当前主流语言的实现肯定会存在性能陷阱，我们是否有办法检测邪恶正则呢？答案是肯定的。</span></span></p></div><div id="https://www.notion.so/434f06601dc94b78b33992709292d9da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在社区里有不少相关项目，例如：</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/doyensec/regexploit">regexploit</a></span><span class="SemanticString"> 、</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/olivo/redos-detector">redos-detector</a></span><span class="SemanticString"> 、</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/davisjam/vuln-regex-detector">vuln-regex-detector</a></span><span class="SemanticString"> 等，它们都可以扫描出有风险的正则，就像这样：</span></span></p></div><pre id="https://www.notion.so/d354c69e27994bd69b3603c9770f8951" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>$ echo &quot;(a+)+s&quot; | regexploit
Pattern: (a+)+s
---
Redos(starriness=11, prefix_sequence=SEQ{  }, redos_sequence=SEQ{ [a]{1+}{1+} [s] }, repeated_character=[a], killer=None)
Worst-case complexity: 11 ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐ (exponential)
Repeated character: [a]
Example: &#x27;a&#x27; * 3456</span></span></span></code></pre><div id="https://www.notion.so/52bd991356e444ee925e9a440b666df9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但是它们局限于静态的正则扫描，对于我们开发者而言，静态防御并不能完全清除风险。更好的思路是直接替换语言的默认实现。以 Python 举例，我们也找到了一些替换库：</span></span></p></div><h3 id="https://www.notion.so/9b807a3d6a4f4382a8ca9a32a39082b9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9b807a3d6a4f4382a8ca9a32a39082b9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">pyre2</span></span></h3><pre id="https://www.notion.so/0400f2139d4848cc921cac11b22d2750" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>pip install pyre2</span></span></span></code></pre><div id="https://www.notion.so/381523b32e57472cbc34ea8246ad0629" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">来自 </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/google/re2/">Google re2</a></span><span class="SemanticString"> 模块的 Python 封装 </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/facebook/pyre2">pyre2</a></span><span class="SemanticString">，使用了 DFA 的构造方式。可以替换原生 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">re</code></span><span class="SemanticString"> 模块，大多数场景都可以得到速度的稳步提升，不存在性能陷阱。</span></span></p></div><div id="https://www.notion.so/6b3f9be98f68408aaddd20fbe922ef3a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但对于 DFA 模拟来说，都是自古华山一条道，比如 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">(?P=&lt;name&gt;)</code></span><span class="SemanticString"> 这样的属于 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">backreference</code></span><span class="SemanticString"> 的捕获组语法就无法支持了。</span></span></p></div><h3 id="https://www.notion.so/843bd650503c440b9f1d67b62c86b850" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/843bd650503c440b9f1d67b62c86b850"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">regex</span></span></h3><pre id="https://www.notion.so/c6d1fae8d54746bf8d73c69f6c8f0f32" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>pip install regex</span></span></span></code></pre><div id="https://www.notion.so/01327456585f4c8ea0e8cae0d24050a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/mrabarnett/mrab-regex">regex</a></span><span class="SemanticString"> 模块</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/mrabarnett/mrab-regex/issues/136">并未使用 DFA 构造</a></span><span class="SemanticString">，在完全兼容 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">re</code></span><span class="SemanticString"> 模块的同时，支持了一些</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/mrabarnett/mrab-regex#old-vs-new-behaviour">新特性</a></span><span class="SemanticString">。由于实现方案的不同，也没有很明确的文档阐述，尚不清楚它具体的算法（</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">有待进一步从代码层面解读</em></span><span class="SemanticString">），但是从效果上，它的性能要</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/mrabarnett/mrab-regex/issues/320">略好于原生模块</a></span><span class="SemanticString">，仅从文中里例子测试看来，也规避了性能陷阱，可以谨慎采用。</span></span></p></div><h2 id="https://www.notion.so/a0e77fa2bc7b4b6fa5b0b831e7132498" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/a0e77fa2bc7b4b6fa5b0b831e7132498"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">总结</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/915c8029555e4bf0872df3a03558c35b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">和很多其他场景一样，程序需要时刻警惕用户的输入，任何不经过校验的内容都可能将程序拖垮。</span></span></li><li id="https://www.notion.so/371b838db8b849bdb7486a0758ef3bc9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">理论和实际存在各种各样的鸿沟，在面临现实场景时，理想的想法落地总是困难的。</span></span></li><li id="https://www.notion.so/f89af5b697ad4da298c7d511af15c4e3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">原生不代表就是最优秀的。有特殊需求时可以使用社区方案进行替换。</span></span></li></ul><div id="https://www.notion.so/a66787f97a4e486fb578736218fd0c05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/277ff37b23aa4f42a7913c853d2099ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参考：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/e9d2dd57275340a485ef23e364ca14d5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://swtch.com/~rsc/regexp/regexp1.html">https://swtch.com/~rsc/regexp/regexp1.html</a></span></span></li><li id="https://www.notion.so/e22e75a8b6fd49e4bbccc126ed671b3c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS">https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS</a></span></span></li><li id="https://www.notion.so/fda27b89107f4b91bf84917191e7f27e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://shivankaul.com/blog/nfa-dfa-and-regexes">https://shivankaul.com/blog/nfa-dfa-and-regexes</a></span></span></li><li id="https://www.notion.so/08210bf6814a4cb593915ac1b3c6218e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://arstechnica.com/civis/viewtopic.php?f=20&amp;t=1195549">https://arstechnica.com/civis/viewtopic.php?f=20&amp;t=1195549</a></span></span></li><li id="https://www.notion.so/7fbcee0eb22b4ebb9b8ae5389c533ff1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://news.ycombinator.com/item?id=466957">https://news.ycombinator.com/item?id=466957</a></span></span></li><li id="https://www.notion.so/51114299fd234300a63828a61a5af429" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://medium.com/swlh/visualizing-thompsons-construction-algorithm-for-nfas-step-by-step-f92ef378581b">https://medium.com/swlh/visualizing-thompsons-construction-algorithm-for-nfas-step-by-step-f92ef378581b</a></span></span></li></ul><div id="https://www.notion.so/be006192e77b457b81f4654035aa1880" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>

  <!-- utterances - Github issue comment -->
  <div>
    <script src="https://utteranc.es/client.js"
      repo="IMBlues/IMBlues.github.io"
      issue-term="pathname"
      label="blog-comment"
      theme="github-light"
      crossorigin="anonymous"
      async>
    </script>
  </div>
  <!-- utterances - Github issue comment -->

  <footer class="Footer">
  <div>&copy; 布鲁斯🐟的奇思乱想 2019-2021</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>
